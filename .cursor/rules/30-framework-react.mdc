---
description: "React UI rules for AI OS control panels, consoles, and visualization surfaces."
globs:
  - "apps/web/**/*.tsx"
  - "apps/web/**/*.jsx"
  - "packages/ui/**/*.tsx"
  - "packages/ui/**/*.jsx"
alwaysApply: false
---

# React Framework Rules for L9 OS UI

## Component Architecture

### Layered Component Design

- **Presentational (Pure)**: Accept props, render. No hooks, no API calls.
- **Container (Smart)**: Fetch data, manage state, pass to presentational.
- **Page**: Compose containers. Route entry point.

### Functional Components Only

- **No class components**: Always use React.FC<Props> or const-arrow syntax.
- **Explicit return type**: React.FC<Props> is preferred over bare function.

---

## Hooks & State Management

### Hook Usage Rules

- **Only call hooks at top level**: Never in loops, conditions, or nested functions.
- **Custom hooks for reuse**: Extract repeated logic into useXxx.
- **Dependency arrays**: Accurate. Use ESLint rule: exhaustive-deps.

### Global State (Zustand)

- **Single store per domain**: useTaskStore, useUIStore, useAuthStore.
- **Immutable updates**: Use Immer to keep updates readable.
- **Selectors for derived state**: Avoid inline selectors in components.

---

## Data Fetching & Async

### Custom Hooks for API Calls

- **useQuery pattern**: Fetch on mount, cache, refetch.
- **Refetch method**: Return function to manually re-fetch.

### Error Handling in Components

- **Three-state rendering**: loading, success, error.
- **User feedback**: Show error message, optionally with retry button.

---

## Real-Time Updates (WebSocket)

### WebSocket Connection Hook

- **Persistent connection via context**: Use WebSocketContext provider.
- **Listen to events**: Use useEffect with ws?.addEventListener pattern.
- **Send messages**: JSON.stringify with type, payload, timestamp.

---

## L9 Agent Control Surfaces

### LChat Panel Component

- Message input with Submit button, disabled during execution
- Execution status with running/success/error states
- Tool calls display with input/output, expandable
- Memory context showing top-k memory facts

### Inspector Panel

- Agent state: agent_id, task_id, iteration count, timeout remaining
- Kernel stack: loaded kernels (Identity, Safety, Execution, Behavioral)
- Tool registry: available tools with capability gates
- Approval queue: pending high-risk tool calls

### Packet Console

- Real-time packet stream (reasoning, tool_call, decision)
- Filter by kind
- Expand packet to show full JSON payload
- Copy/export as JSON

---

## Performance Optimization

### Memoization

- **useMemo** for expensive computations
- **useCallback** for stable function refs
- **React.memo** for pure components

### Code Splitting

- **Lazy load heavy components** with React.lazy and Suspense

---

## Testing React Components

### Unit Tests (RTL)

- Use React Testing Library with userEvent
- Prefer behavioral assertions over snapshots

---

## Accessibility

### ARIA & Semantic HTML

- **Use semantic tags**: button, input, not div with onclick
- **ARIA labels**: For dynamic content or icons
- **Role attributes**: Clarify complex widgets

### Keyboard & Focus

- **Tab order**: Logical flow. Use tabIndex sparingly.
- **Focus visible**: :focus-visible pseudo-class for keyboard users
- **Escape closes modals**: Build modal hook

---

## Styling

### CSS-in-JS vs Tailwind

- **Prefer Tailwind** for rapid UI development. BEM class names for complex components.
- **CSS modules** for scoped styles when needed.
- **Design tokens**: Use CSS variables for colors, spacing, typography.

### Dark Mode

- **Support system preference**: window.matchMedia prefers-color-scheme
- **Toggle manually**: Store in localStorage
