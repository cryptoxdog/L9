---
description: "Deployment manifest and orchestrator wiring rules derived from DEPLOYMENT_MANIFEST_v1.7 and GMP orchestrator prompts."
globs:
  - "docker-compose.yml"
  - "deploy/**/*"
  - "infra/**/*"
  - "kubernetes/**/*"
  - "helm/**/*"
alwaysApply: false
---

# Deployment & orchestrator manifests (L9)

## Protected deployment surfaces

- Treat all deployment artifacts described in the deployment manifest spec as **protected**:
  - Core services (API, executor, orchestrator, memory substrate).
  - Datastores (Postgres, Neo4j, Redis, blob storage).
  - Ingress / networking components.
- Any change here must:
  - Have a **Phase 0 plan** specifically for deployment.
  - Use **GMP deployment and orchestrator wiring prompts** for implementation and tests.

---

## Orchestrator wiring rules

- When touching orchestrator wiring (WS orchestrator, task router, plan executor, MQ/Redis links), use patterns from the orchestrator wiring GMP prompts.
- Always:
  - Diagram the before/after message flow (even briefly in the prompt).
  - Identify timeouts, retry policies, and failure paths.
  - Add or update **integration tests** that exercise cross‑service communication.

---

## Deployment validation

- For any manifest change, define and run **deployment‑level tests** inspired by:
  - Critical-path tests (end-to-end flows).
  - Integration tests (service boundaries, orchestrator + memory + executor).
- At minimum:
  - Validate all services start (no CrashLoopBackOff / container failures).
  - Verify health endpoints for each critical service.
  - Run one end‑to‑end GMP‑style scenario (e.g., L‑chat through executor to memory).

---

## Safety constraints for infra changes

- Never:
  - Change persistent data volumes without explicit backup/rollback plan.
  - Relax network boundaries (e.g., expose internal ports publicly) without documenting risk and mitigations.
- Always:
  - Keep **critical environment variables** aligned with the manifest spec.
  - Document any new required env vars in the deployment manifest doc and `.env.example`.

---

## Rollback readiness

- For every manifest or orchestrator wiring change, define:
  - **Rollback steps** (previous image tags, manifests, or helm values).
  - **Verification checklist** for rollback success (services healthy, no data loss).
- Do not merge manifest changes that lack a clear rollback story matching the deployment manifest guidance.

---

## Protected core reference

- The authoritative list of **protected L9 core and infra files** is maintained in `90-protected-core.mdc`.
- This file adds deployment- and manifest-specific rules (wiring, smoke tests, rollback), but it does **not** change which files are considered protected.
