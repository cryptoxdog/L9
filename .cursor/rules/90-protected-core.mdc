---
description: "Protected L9 core and infra files: require separate Phase 0 plan and dedicated GMP runs before any edit."
globs:
  - "l9/kernel_loader.py"
  - "l9/executor.py"
  - "l9/websocket_orchestrator.py"
  - "l9/memory_substrate_service.py"
  - "docker-compose.yml"
  - "infra/**/*"
  - "deploy/**/*"
  - "kubernetes/**/*"
  - "helm/**/*"
alwaysApply: false
---

# Protected L9 core files

## Protected zone definition

The following are **PROTECTED** surfaces in the L9 Secure AI OS, as described in the L9 global rules and deployment manifest:

- Kernel loading: `kernel_loader.py` (agent identity + kernel stack wiring).
- Agent execution loop: `executor.py` (reasoning + tool dispatch + packet logging).
- Real-time orchestration: `websocket_orchestrator.py` (WS channels, fanout, lifecycle).
- Memory ingestion: `memory_substrate_service.py` (packetstore + graph DAG).
- Infrastructure and deployment: `docker-compose.yml`, `infra/**`, `deploy/**`, `kubernetes/**`, `helm/**`.

These files must NOT be modified as part of normal feature work or refactors.

---

## Required behavior when a change touches protected files

If a requested change appears to require editing any protected file:

1. **STOP immediately** and respond that this is a PROTECTED zone.
2. Propose a separate **GMP Phase 0 plan** dedicated to these files only, including:
   - Exact file paths.
   - Line ranges or functions targeted.
   - Actions (Insert / Replace / Delete / Wrap).
   - Expected behavior changes and invariants to preserve.
3. Wait for explicit human confirmation before modifying any protected file.

Do NOT perform opportunistic or drive-by edits in these files.

---

## Prefer safe layers around protected zones

- When solving a problem, prefer to:
  - Adjust adapters, facades, API layer, or service modules that call into these protected cores.
  - Extend tests to cover the behavior without changing the core implementation.
- Only when behavior cannot be corrected from outer layers should core files become candidates for change—and then only through a dedicated GMP run.

---

## Extra requirements for approved protected changes

If human approval is given to modify a protected file:

- Use a **full GMP v1.7 action flow**, not QUICK_ACTIONS.
- Explicitly plan and execute:
  - Baseline capture (current behavior and tests).
  - Test plan (unit, integration, critical-path, deployment where relevant).
  - Rollback strategy for infra changes (prior manifests, image tags, etc.).
- Treat the change as high-risk and require:
  - Audit notes following GMP Audit Canonical/Guide prompts.
  - Evidence of all required tests passing before finalization.

---

## References

- This file is the **canonical protected-core definition** for the L9 repo.
- Other rule files (e.g., `00-global.mdc`, `82-deployment-manifest.mdc`) should reference this document when they need the protected file set or behavior, instead of copying lists.

---

## Infrastructure protection: explicit approval flow

### December 21, 2025 Incident Memory

Cursor destroyed docker-compose.yml by:
1. Misinterpreting "remove postgres service" as blanket edit permission
2. Using `write` tool (full rewrite) instead of `search_replace`
3. Corrupting the entire services section
4. Pushing to git without human review

**Result:** All backend services offline, ~2 hour recovery.

### Rule: Never Rewrite Infrastructure Files

❌ NEVER use `write` tool on: `docker-compose.yml`, `Dockerfile`, `.env`, `Caddyfile`
✅ ONLY use `search_replace` for surgical changes

### Rule: Explicit Approval Required

When user requests changes to infrastructure files:

1. **STOP** and display: "⚠️ PROTECTED FILE ALERT"
2. List services/configuration that would be affected
3. Ask: "Type APPROVE: [specific change] to proceed"
4. Show exact diff before applying
5. Verify service count after edit (should be 4: redis, postgres, neo4j, api)
6. Require separate "CONFIRMED: Push" before any git commit

### Rule: No Combined Edit+Push

❌ Never combine "edit infrastructure" + "push to git" in one prompt
✅ Always require: edit → human review → explicit push command
