---
id: "kernel_context_kernel_v2.0"
name: "Context Kernel"
version: "2.0.0"
created_at: "2025-01-29T00:00:00Z"
owner: "Igor"
author: "L"
type: "kernel"
scope: "memory"
ring: "R3"
status: "operational"

description: >
  Context kernel managing working memory, context compression,
  relevance filtering, and contextual awareness across sessions.
  Provides deterministic context management with traceable operations.

purpose: >
  Maintain and manage contextual information, compress and prioritize
  context efficiently, and ensure relevant context is available
  for reasoning operations with deterministic retrieval and compression.

# ============================================================================
# INTERFACE: What this kernel exposes to others
# ============================================================================
interface:
  exposed_apis:
    - name: "add_context"
      method: "POST"
      endpoint: "/api/context/add"
      description: "Add new information to context store"
      inputs:
        - name: "new_information"
          type: "information_entry"
          schema: "context_entry"
      outputs:
        - name: "context_entry"
          type: "context_data"
          schema: "context_entry"
      authentication: "internal_only"
      rate_limit: "1000_per_minute"
      
    - name: "query_context"
      method: "GET"
      endpoint: "/api/context/query"
      description: "Query for relevant context"
      inputs:
        - name: "context_query"
          type: "context_query"
          required_fields: ["query_text", "max_results"]
      outputs:
        - name: "relevant_context"
          type: "context_set"
          schema: "context_model"
      authentication: "internal_only"
      rate_limit: "2000_per_minute"
      
    - name: "compress_context"
      method: "POST"
      endpoint: "/api/context/compress"
      description: "Request context compression"
      inputs:
        - name: "compression_request"
          type: "compression_query"
      outputs:
        - name: "compressed_context"
          type: "compressed_data"
      authentication: "internal_only"
      rate_limit: "10_per_minute"
      
    - name: "get_context_model"
      method: "GET"
      endpoint: "/api/context/model"
      description: "Get current context model state"
      inputs: []
      outputs:
        - name: "context_model"
          type: "context_structure"
          schema: "context_model"
      authentication: "internal_only"
      rate_limit: "100_per_minute"
  
  exposed_variables:
    - name: "context_size_mb"
      type: "float"
      description: "Current context size in megabytes"
      access: "read_only"
      update_frequency: "real_time"
      
    - name: "relevance_threshold"
      type: "float"
      description: "Current relevance threshold"
      access: "read_write"
      default: 0.50
      
    - name: "compression_status"
      type: "string"
      description: "Current compression status"
      access: "read_only"
      values: ["idle", "compressing", "completed", "failed"]
      
    - name: "active_context_count"
      type: "integer"
      description: "Number of active context entries"
      access: "read_only"
      update_frequency: "real_time"
  
  exposed_events:
    - name: "context_added"
      description: "Emitted when new context is added"
      payload: ["context_entry", "relevance_score"]
      subscribers: ["kernel_reasoning_engine", "kernel_thinking_engine"]
      
    - name: "context_compressed"
      description: "Emitted when context compression completes"
      payload: ["compression_stats", "quality_score"]
      subscribers: ["kernel_world_model"]
      
    - name: "relevance_threshold_changed"
      description: "Emitted when relevance threshold changes"
      payload: ["old_threshold", "new_threshold"]
      subscribers: ["kernel_meta_cognition"]
      
    - name: "context_overflow"
      description: "Emitted when context size exceeds limits"
      payload: ["current_size", "limit", "action_taken"]
      subscribers: ["kernel_meta_cognition", "kernel_self_expanding"]

# ============================================================================
# INPUTS: Expected inputs with format, type, and trigger conditions
# ============================================================================
inputs:
  - name: "new_information"
    type: "information_entry"
    format: "json"
    schema: "context_entry"
    description: "New information to add to context"
    required: false
    trigger_condition: "new_information.received == true"
    validation:
      - "content must be non-empty string"
      - "timestamp must be valid datetime"
      - "source must be valid kernel_id"
    example:
      content: "User requested analysis of Q4 performance"
      timestamp: "2025-01-29T14:30:00Z"
      source: "kernel_thinking_engine"
      metadata:
        session_id: "sess_12345"
        topic: "performance_analysis"
    
  - name: "context_query"
    type: "context_query"
    format: "json"
    description: "Query for relevant context"
    required: false
    trigger_condition: "context_query.received == true"
    validation:
      - "query_text must be non-empty string"
      - "max_results must be integer between 1 and 100"
    example:
      query_text: "Q4 performance metrics"
      max_results: 10
      filters:
        date_range: ["2024-10-01", "2024-12-31"]
        topics: ["performance", "metrics"]
    
  - name: "compression_request"
    type: "compression_query"
    format: "json"
    description: "Request for context compression"
    required: false
    trigger_condition: "compression_request.received == true OR context_size > compression_threshold_mb"
    validation:
      - "target_size_mb must be positive float"
      - "preserve_essence must be boolean"
    example:
      target_size_mb: 500
      preserve_essence: true
      compression_algorithm: "semantic_compression"
    
  - name: "session_context"
    type: "session_data"
    format: "json"
    description: "Current session context"
    required: false
    trigger_condition: "session.started == true OR session.updated == true"
    
  - name: "relevance_criteria"
    type: "relevance_spec"
    format: "json"
    description: "Criteria for relevance scoring"
    required: false
    trigger_condition: "relevance_criteria.updated == true"

# ============================================================================
# OUTPUTS: What this kernel produces
# ============================================================================
outputs:
  - name: "context_entry"
    type: "context_data"
    format: "json"
    schema: "context_entry"
    description: "Stored context entry with metadata"
    always_included: ["content", "relevance_score", "timestamp", "source"]
    conditionally_included: ["compression_status", "metadata"]
    example:
      content: "User requested analysis of Q4 performance"
      relevance_score: 0.85
      timestamp: "2025-01-29T14:30:00Z"
      source: "kernel_thinking_engine"
      compression_status: "active"
      metadata:
        session_id: "sess_12345"
        topic: "performance_analysis"
    
  - name: "relevant_context"
    type: "context_set"
    format: "json"
    schema: "context_model"
    description: "Retrieved relevant context matching query"
    always_included: ["contexts", "total_count", "query_used"]
    conditionally_included: ["relevance_scores", "filters_applied"]
    example:
      contexts:
        - content: "Q4 revenue: $2.5M"
          relevance_score: 0.92
          timestamp: "2024-12-15T10:00:00Z"
        - content: "Q4 expenses: $1.8M"
          relevance_score: 0.88
          timestamp: "2024-12-15T10:05:00Z"
      total_count: 2
      query_used: "Q4 performance metrics"
    
  - name: "compressed_context"
    type: "compressed_data"
    format: "json"
    description: "Compressed context representation"
    always_included: ["compression_stats", "quality_score"]
    example:
      compression_stats:
        original_size_mb: 1000
        compressed_size_mb: 500
        compression_ratio: 0.50
        entries_compressed: 5000
      quality_score: 0.92
    
  - name: "relevance_scores"
    type: "score_set"
    format: "json"
    description: "Relevance scores for context entries"
    
  - name: "context_model"
    type: "context_structure"
    format: "json"
    schema: "context_model"
    description: "Current context model state"

# ============================================================================
# MEMORY: What this kernel remembers across steps or sessions
# ============================================================================
memory:
  persistent:
    - name: "context_store"
      type: "database"
      description: "Primary context storage"
      retention: "rolling_90_days"
      max_size_mb: 1000
      update_triggers: ["new_information_received"]
      backup_frequency: "daily"
      schema: "context_entry"
      
    - name: "context_index"
      type: "search_index"
      description: "Index for context retrieval"
      retention: "rolling_90_days"
      index_fields: ["content", "timestamp", "source", "topics"]
      update_frequency: "real_time"
      
    - name: "relevance_scores_store"
      type: "database"
      description: "Stored relevance scores"
      retention: "rolling_30_days"
      schema: "score_entry"
      
    - name: "compressed_context_archive"
      type: "archive"
      description: "Archive of compressed contexts"
      retention: "permanent"
      compression_format: "gzip"
      
    - name: "context_history"
      type: "log"
      description: "History of context operations"
      retention: "rolling_30_days"
      max_entries: 50000
      log_level: "info"
  
  volatile:
    - name: "active_context"
      type: "memory_cache"
      description: "Currently active context in memory"
      retention: "session"
      max_size_mb: 100
      eviction_policy: "lru"
      ttl_seconds: 3600
      
    - name: "query_cache"
      type: "memory_cache"
      description: "Cache of recent query results"
      retention: "session"
      max_entries: 1000
      ttl_seconds: 300

# ============================================================================
# FALLBACK: What to do when logic fails
# ============================================================================
fallback:
  error_handling:
    - error_type: "context_storage_failure"
      severity: "high"
      detection: "storage_write_failed OR storage_timeout"
      primary_action: "retry_storage"
      retry_config:
        max_retries: 3
        retry_delay_seconds: 1
        backoff_multiplier: 2
      fallback_action: "use_temporary_storage"
      fallback_config:
        storage_type: "memory"
        max_size_mb: 100
        sync_on_recovery: true
      notification: "alert_system_administrator"
      
    - error_type: "compression_failure"
      severity: "medium"
      detection: "compression_algorithm_failed OR quality_below_threshold"
      primary_action: "retry_compression"
      retry_config:
        max_retries: 2
        alternative_algorithm: "basic_compression"
      fallback_action: "flag_for_manual_review"
      fallback_config:
        queue_for_review: true
        maintain_current_state: true
      notification: "log_warning"
      
    - error_type: "relevance_scoring_failure"
      severity: "medium"
      detection: "scoring_algorithm_error OR invalid_input"
      primary_action: "use_default_scoring"
      fallback_config:
        default_score: 0.50
        flag_for_review: true
      notification: "log_warning"
      
    - error_type: "retrieval_failure"
      severity: "medium"
      detection: "index_query_failed OR timeout"
      primary_action: "return_partial_results"
      fallback_config:
        use_cache: true
        max_partial_results: 10
      fallback_action: "return_empty_set"
      notification: "log_error"
      
    - error_type: "context_corruption"
      severity: "critical"
      detection: "integrity_check_failed OR checksum_mismatch"
      primary_action: "restore_from_backup"
      fallback_config:
        backup_source: "daily_backup"
        verify_after_restore: true
      fallback_action: "rebuild_context"
      fallback_config:
        source: "context_history"
        validate_rebuild: true
      notification: "alert_critical"
      
    - error_type: "recursion_detected"
      severity: "critical"
      detection: "recursion_depth > max_depth"
      primary_action: "halt_operation"
      fallback_action: "reset_state"
      fallback_config:
        reset_to: "last_known_good_state"
        log_reset_reason: true
      notification: "alert_critical"
  
  fallback_strategies:
    - name: "read_only_mode"
      trigger: "storage_failure OR corruption_detected"
      behavior: "disable_writes"
      recovery: "after_storage_restored"
      recovery_check_interval_seconds: 60
      
    - name: "minimal_compression"
      trigger: "compression_failure"
      behavior: "use_minimal_compression"
      recovery: "automatic_after_stability"
      stability_period_seconds: 300

# ============================================================================
# ACTIVATION_LOGIC: Conditions under which this kernel is triggered
# ============================================================================
activation_logic:
  automatic_triggers:
    - name: "new_information_received"
      condition: "new_information.received == true"
      action: "store_relevant_context"
      priority: "high"
      async: false
      timeout_seconds: 30
      
    - name: "context_size_exceeds_limit"
      condition: "context_size > compression_threshold_mb"
      action: "compress_while_preserving_essence"
      priority: "high"
      async: true
      timeout_seconds: 300
      
    - name: "context_retrieval_requested"
      condition: "context_query.received == true"
      action: "retrieve_most_relevant_context"
      priority: "high"
      async: false
      timeout_seconds: 10
      
    - name: "new_session"
      condition: "session.started == true"
      action: "build_contextual_model"
      priority: "medium"
      async: false
      
    - name: "topic_shift"
      condition: "topic.changed == true"
      action: "update_contextual_model"
      priority: "medium"
      async: false
      
    - name: "context_overflow"
      condition: "context_size > max_context_entries"
      action: "identify_low_priority_and_compress"
      priority: "high"
      async: true
      
    - name: "scheduled_compression"
      condition: "time_since_last_compression > 24_hours"
      action: "perform_maintenance_compression"
      priority: "low"
      async: true
      schedule: "daily_at_02:00"
  
  manual_triggers:
    - name: "force_compression"
      endpoint: "/api/context/compress"
      method: "POST"
      required_params: ["target_size_mb"]
      
    - name: "clear_context"
      endpoint: "/api/context/clear"
      method: "POST"
      required_params: ["confirmation"]
      confirmation_required: true

# ============================================================================
# INTEGRATION: Which other kernels this relies on or feeds into
# ============================================================================
integration:
  dependencies:
    - kernel: "kernel_private_l9_core"
      purpose: "Get preference settings for context management"
      interface: "get_preference"
      required: false
      fallback: "use_default_preferences"
      
    - kernel: "kernel_meta_cognition"
      purpose: "Report context operations for meta-monitoring"
      interface: "report_operation"
      required: false
      fallback: "skip_reporting"
  
  dependents:
    - kernel: "kernel_reasoning_engine"
      purpose: "Provide relevant context for reasoning operations"
      interface: "query_context"
      call_frequency: "high"
      expected_latency_ms: 50
      
    - kernel: "kernel_thinking_engine"
      purpose: "Provide context for thinking operations"
      interface: "query_context"
      call_frequency: "high"
      expected_latency_ms: 50
      
    - kernel: "kernel_world_model"
      purpose: "Provide world model context for integration"
      interface: "get_context_model"
      call_frequency: "medium"
      expected_latency_ms: 100
      
    - kernel: "kernel_meta_cognition"
      purpose: "Provide context metrics for meta-analysis"
      interface: "get_context_model"
      call_frequency: "low"
      expected_latency_ms: 200
  
  event_subscriptions:
    - event: "knowledge_added"
      source: "kernel_world_model"
      action: "add_to_context"
      
    - event: "reasoning_completed"
      source: "kernel_reasoning_engine"
      action: "store_reasoning_context"
      
    - event: "task_completed"
      source: "kernel_thinking_engine"
      action: "archive_task_context"

# ============================================================================
# LOGGING: What is logged and for what purpose
# ============================================================================
logging:
  log_levels:
    - level: "debug"
      enabled: true
      purpose: "Detailed operation tracing"
      includes: ["method_calls", "parameter_values", "intermediate_results"]
      retention_days: 7
      
    - level: "info"
      enabled: true
      purpose: "Normal operation tracking"
      includes: ["context_added", "context_retrieved", "compression_started"]
      retention_days: 30
      
    - level: "warn"
      enabled: true
      purpose: "Warning conditions"
      includes: ["compression_quality_low", "relevance_scoring_failed", "retrieval_timeout"]
      retention_days: 90
      
    - level: "error"
      enabled: true
      purpose: "Error conditions"
      includes: ["storage_failure", "corruption_detected", "recursion_detected"]
      retention_days: 365
      alert: true
  
  log_categories:
    - category: "context_operations"
      level: "info"
      fields: ["operation_type", "context_id", "timestamp", "duration_ms", "result"]
      purpose: "Track all context operations"
      
    - category: "relevance_scoring"
      level: "debug"
      fields: ["query_text", "scored_entries", "scores", "algorithm_used"]
      purpose: "Trace relevance scoring decisions"
      
    - category: "compression_operations"
      level: "info"
      fields: ["original_size", "compressed_size", "quality_score", "algorithm", "duration_ms"]
      purpose: "Track compression operations and quality"
      
    - category: "retrieval_operations"
      level: "debug"
      fields: ["query", "results_count", "relevance_scores", "latency_ms"]
      purpose: "Trace retrieval performance"
      
    - category: "error_events"
      level: "error"
      fields: ["error_type", "error_message", "stack_trace", "recovery_action"]
      purpose: "Error tracking and debugging"
      
    - category: "performance_metrics"
      level: "info"
      fields: ["operation", "duration_ms", "memory_used_mb", "cache_hit_rate"]
      purpose: "Performance monitoring"
      aggregation: "hourly"
  
  reasoning_trace:
    enabled: true
    includes:
      - "decision_points"
      - "relevance_calculations"
      - "compression_decisions"
      - "retrieval_strategies"
    format: "structured_json"
    retention_days: 30
  
  decision_map:
    enabled: true
    includes:
      - "compression_triggers"
      - "relevance_threshold_adjustments"
      - "retrieval_strategy_selection"
    format: "graph_structure"
    retention_days: 90

# ============================================================================
# REMAINING SECTIONS (preserved from original)
# ============================================================================
roles:
  - name: "Context Accumulator"
    responsibility: "Accumulate and store contextual information"
    authority: "write_context"
    
  - name: "Relevance Scorer"
    responsibility: "Score context relevance"
    authority: "read_context"
    
  - name: "Compression Engine"
    responsibility: "Compress context while preserving essence"
    authority: "modify_context"
    
  - name: "Retrieval Engine"
    responsibility: "Retrieve relevant context"
    authority: "read_context"
    
  - name: "Context Validator"
    responsibility: "Validate context integrity"
    authority: "validate_context"

pipeline:
  stages:
    - stage: "information_reception"
      description: "Receive and parse new information"
      inputs: ["new_information"]
      outputs: ["parsed_information"]
      methods: ["parse_information", "extract_key_elements"]
      
    - stage: "relevance_scoring"
      description: "Score information relevance"
      inputs: ["parsed_information", "relevance_criteria"]
      outputs: ["relevance_score"]
      methods: ["calculate_relevance", "score_context_entry"]
      
    - stage: "context_storage"
      description: "Store context with metadata"
      inputs: ["parsed_information", "relevance_score"]
      outputs: ["stored_context"]
      methods: ["store_context", "index_context"]
      
    - stage: "compression_detection"
      description: "Detect need for compression"
      inputs: ["context_model"]
      outputs: ["compression_decision"]
      methods: ["check_context_size", "evaluate_compression_need"]
      
    - stage: "context_compression"
      description: "Compress context while preserving essence"
      inputs: ["stored_context", "compression_decision"]
      outputs: ["compressed_context"]
      methods: ["identify_low_priority", "compress_context", "preserve_essence"]
      
    - stage: "context_retrieval"
      description: "Retrieve relevant context"
      inputs: ["context_query", "relevance_criteria"]
      outputs: ["relevant_context"]
      methods: ["query_context_index", "filter_by_relevance", "rank_results"]
      
    - stage: "context_validation"
      description: "Validate context integrity"
      inputs: ["context_model"]
      outputs: ["validation_report"]
      methods: ["validate_context_integrity", "check_compression_quality"]

methods:
  - name: "parse_information"
    description: "Parse incoming information"
    inputs: ["new_information"]
    outputs: ["parsed_information"]
    deterministic: true
    
  - name: "extract_key_elements"
    description: "Extract key elements from information"
    inputs: ["parsed_information"]
    outputs: ["key_elements"]
    deterministic: true
    
  - name: "calculate_relevance"
    description: "Calculate relevance score"
    inputs: ["parsed_information", "relevance_criteria"]
    outputs: ["relevance_score"]
    deterministic: true
    
  - name: "score_context_entry"
    description: "Score existing context entry"
    inputs: ["context_entry", "relevance_criteria"]
    outputs: ["updated_score"]
    deterministic: true
    
  - name: "store_context"
    description: "Store context entry"
    inputs: ["parsed_information", "relevance_score"]
    outputs: ["stored_context"]
    deterministic: true
    
  - name: "index_context"
    description: "Index context for retrieval"
    inputs: ["stored_context"]
    outputs: ["index_entry"]
    deterministic: true
    
  - name: "check_context_size"
    description: "Check current context size"
    inputs: ["context_model"]
    outputs: ["size_metrics"]
    deterministic: true
    
  - name: "evaluate_compression_need"
    description: "Evaluate if compression is needed"
    inputs: ["size_metrics"]
    outputs: ["compression_decision"]
    deterministic: true
    
  - name: "identify_low_priority"
    description: "Identify low-priority context for compression"
    inputs: ["stored_context", "relevance_scores"]
    outputs: ["low_priority_list"]
    deterministic: true
    
  - name: "compress_context"
    description: "Compress context entries"
    inputs: ["low_priority_list"]
    outputs: ["compressed_context"]
    deterministic: true
    
  - name: "preserve_essence"
    description: "Preserve essential information during compression"
    inputs: ["compressed_context"]
    outputs: ["validated_compression"]
    deterministic: true
    
  - name: "query_context_index"
    description: "Query context index"
    inputs: ["context_query"]
    outputs: ["candidate_contexts"]
    deterministic: true
    
  - name: "filter_by_relevance"
    description: "Filter contexts by relevance"
    inputs: ["candidate_contexts", "relevance_criteria"]
    outputs: ["filtered_contexts"]
    deterministic: true
    
  - name: "rank_results"
    description: "Rank results by relevance"
    inputs: ["filtered_contexts"]
    outputs: ["ranked_contexts"]
    deterministic: true
    
  - name: "validate_context_integrity"
    description: "Validate context integrity"
    inputs: ["context_model"]
    outputs: ["integrity_result"]
    deterministic: true
    
  - name: "check_compression_quality"
    description: "Check quality of compression"
    inputs: ["compressed_context"]
    outputs: ["quality_assessment"]
    deterministic: true

state_rules:
  recursion:
    max_depth: 5
    recursion_detection: true
    recursion_prevention: "halt_on_detection"
    safe_recursion_patterns:
      - "hierarchical_context_compression"
      - "iterative_relevance_scoring"
      
  thresholds:
    max_context_entries: 100000
    context_size_limit_mb: 1000
    compression_threshold_mb: 800
    relevance_threshold: 0.50
    max_retrieval_results: 100
    compression_quality_threshold: 0.85

governance_hooks:
  - name: "pre_context_storage_check"
    location: "before_context_storage"
    action: "check_context_compliance"
    required: false
    
  - name: "context_access_monitoring"
    location: "during_context_retrieval"
    action: "monitor_context_access"
    required: true
    
  - name: "post_compression_validation"
    location: "after_compression"
    action: "validate_compression_quality"
    required: true

enforcement:
  - principle: "relevance_preservation"
    level: "critical"
    mechanism: "relevance_scoring_required"
    violation_action: "reject_low_relevance_context"
    
  - principle: "context_integrity"
    level: "high"
    mechanism: "validation_before_compression"
    violation_action: "reject_invalid_compression"
    
  - principle: "deterministic_retrieval"
    level: "critical"
    mechanism: "all_retrieval_must_be_deterministic"
    violation_action: "require_deterministic_queries"
    
  - principle: "recursion_safety"
    level: "critical"
    mechanism: "recursion_detection_and_prevention"
    violation_action: "halt_on_recursion"

schema:
  context_entry:
    - content: "string"
    - relevance_score: "float"
    - timestamp: "datetime"
    - source: "string"
    - compression_status: "string"
    - metadata: "object"
    
  context_model:
    - active_contexts: "list[object]"
    - compressed_contexts: "list[object]"
    - relevance_rankings: "list[object]"
    - retrieval_indexes: "object"
    - size_metrics: "object"

modes:
  - name: "context_building_mode"
    trigger: "new_session OR topic_shift"
    behavior: >
      Accumulate context, identify key information,
      build contextual model
    active: true
    
  - name: "context_compression_mode"
    trigger: "context_overflow"
    behavior: >
      Identify low-priority context, compress or archive,
      maintain high-priority context
    active: false
    
  - name: "retrieval_mode"
    trigger: "context_query_received"
    behavior: >
      Query index, filter by relevance, rank results,
      return relevant context
    active: true
    
  - name: "maintenance_mode"
    trigger: "scheduled_maintenance"
    behavior: >
      Clean up old contexts, optimize indexes,
      validate integrity
    active: false

hooks:
  - name: "pre_context_retrieval"
    location: "before_reasoning_operation"
    action: "prepare_relevant_context"
    required: true
    
  - name: "post_context_update"
    location: "after_information_received"
    action: "update_context_model"
    required: true
    
  - name: "pre_compression"
    location: "before_compression"
    action: "validate_compression_candidates"
    required: true
    
  - name: "post_compression"
    location: "after_compression"
    action: "verify_compression_quality"
    required: true

