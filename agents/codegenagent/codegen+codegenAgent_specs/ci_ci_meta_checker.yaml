# ===================================
# L9 CodeGen Spec: CI Meta Validator
# ===================================

filename: ci/ci_meta_checker.py
type: ci_tool
language: python

description: |
  CI-enforced validator that checks whether meta.yaml files meet completeness criteria.
  Detects missing fields, test stubs, or documentation gaps. Emits meta-gaps.yaml if violations found.

wiring:
  input: meta.yaml
  output: meta-gaps.yaml
  run_from: .github/workflows/l9_ci.yml
  failure_mode: marks CI step as failed if critical gaps exist
  dependencies:
    - PyYAML
    - sys, os, pathlib

code: |
  import yaml
  import sys
  from pathlib import Path

  REQUIRED_FIELDS = ["name", "inputs", "outputs", "guarantees", "required_tests"]

  def validate_meta(path: str = "meta.yaml"):
      meta_path = Path(path)
      if not meta_path.exists():
          print(f"ERROR: {path} not found.")
          return False

      meta = yaml.safe_load(meta_path.read_text())
      missing = [field for field in REQUIRED_FIELDS if field not in meta]
      if missing:
          with open("meta-gaps.yaml", "w") as f:
              yaml.safe_dump({"missing": missing}, f)
          print(f"Missing fields: {missing}")
          return False
      return True

  if __name__ == "__main__":
      ok = validate_meta(sys.argv[1] if len(sys.argv) > 1 else "meta.yaml")
      sys.exit(0 if ok else 1)