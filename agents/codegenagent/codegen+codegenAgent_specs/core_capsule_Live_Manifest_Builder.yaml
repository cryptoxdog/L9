# ============================================================
# PATCH â€” Live_Manifest_Builder.py
# Purpose: Add schema lineage and regeneration flag tracking
# ============================================================

filename: core/capsule/Live_Manifest_Builder.py
patch_type: lineage_extension
language: python
description: |
  Adds more detailed lineage metadata, including schema hash,
  regeneration triggers, and patch suggestions.

patch:
  update_function: build_manifest
  recursive_enrichment_passes: 3
  enriched_code: |
    def build_manifest():
        manifest = scan_generated_assets()
        with open('manifests/live_manifest.json', 'w') as f:
            json.dump(manifest, f, indent=2)

        lineage = []
        for asset in manifest.get("agents", []):
            schema_path = asset.get("schema_path", "")
            schema_hash = compute_hash(schema_path)
            construct_id = asset.get("name", "")
            features = asset.get("features_enabled", [])
            outputs = asset.get("outputs", [])
            triggers = asset.get("triggered_by", [])

            lineage.append({
                "construct_id": construct_id,
                "schema_path": schema_path,
                "schema_hash": schema_hash,
                "features_enabled": features,
                "linked_outputs": outputs,
                "regeneration_flags": triggers,
                "timestamp": datetime.datetime.utcnow().isoformat() + "Z"
            })

        with open('manifests/construct_lineage.json', 'w') as f:
            json.dump(lineage, f, indent=2)