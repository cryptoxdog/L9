# ============================================================
# PATCH â€” Live_Manifest_Builder.py
# Purpose: Add schema lineage and regeneration flag tracking
# ============================================================

filename: core/capsule/Live_Manifest_Builder.py
patch_type: lineage_extension
language: python
description: |
  Adds more detailed lineage metadata, including schema hash,
  regeneration triggers, and patch suggestions.

patch:
  update_function: build_manifest
  recursive_enrichment_passes: 3
  enriched_code: |
    def build_manifest():
        manifest = scan_generated_assets()
        with open('manifests/live_manifest.json', 'w') as f:
            json.dump(manifest, f, indent=2)

        lineage = []
        for asset in manifest.get("agents", []):
            schema_path = asset.get("schema_path", "")
            schema_hash = compute_hash(schema_path)
            construct_id = asset.get("name", "")
            features = asset.get("features_enabled", [])
            outputs = asset.get("outputs", [])
            triggers = asset.get("triggered_by", [])

            lineage.append({
                "construct_id": construct_id,
                "schema_path": schema_path,
                "schema_hash": schema_hash,
                "features_enabled": features,
                "linked_outputs": outputs,
                "regeneration_flags": triggers,
                "timestamp": datetime.datetime.utcnow().isoformat() + "Z"
            })

        with open('manifests/construct_lineage.json', 'w') as f:
            json.dump(lineage, f, indent=2)
# ============================================================================
# L9 DORA BLOCK - AUTO-GENERATED - DO NOT EDIT
# ============================================================================
l9_dora:
  component_id: "AGE-INTE-032"
  component_name: "Core Capsule Live Manifest Builder"
  module_version: "1.0.0"
  created_at: "2026-01-08T03:17:26Z"
  created_by: "L9_DORA_Injector"
  layer: "intelligence"
  domain: "agent_execution"
  type: "config"
  status: "active"
  governance_level: "critical"
  compliance_required: true
  audit_trail: true
  purpose: "Configuration file for core capsule Live Manifest Builder"
  dependencies: []
# ============================================================================
# END L9 DORA BLOCK
# ============================================================================
