schema_version: 2.6.0
meta:
  schema_version: 2.6.0
  template_version: 2.6.0
  created_at: '2025-12-18T06:24:54.747868+00:00'
  created_by: spec_compiler
  last_updated_at: '2025-12-18T06:24:54.831826+00:00'
  last_updated_by: policy_applier
  last_commit_sha: SPEC-62d9295fc71f
  finalized_at: '2025-12-18T06:24:54.831826+00:00'
  finalized_by: policy_applier
metadata:
  module_id: email.adapter
  name: Email Adapter
  tier: 1
  description: Receives inbound emails via webhook, parses content, and routes to
    AIOS for processing. Supports Gmail API integration.
  system: L9
  language: python
  runtime: python>=3.11
ownership:
  team: integrations
  primary_contact: integrations_lead
runtime_wiring:
  service: api
  startup_phase: normal
  depends_on:
  - postgres
  - memory.service
  blocks_startup_on_failure: false
  placement: fastapi_route_handler
runtime_contract:
  runtime_class: control_plane
  execution_model: request_driven
external_surface:
  exposes_http_endpoint: true
  exposes_webhook: true
  exposes_tool: false
  callable_from:
  - external
  - internal
dependency_contract:
  inbound:
  - from_module: external
    interface: http
    endpoint: /email/webhook
  outbound:
  - to_module: aios.runtime
    interface: http
    endpoint: /chat
  - to_module: memory.service
    interface: http
    endpoint: /memory/ingest
  - to_module: external
    interface: http
    endpoint: gmail.users.messages.get
  - to_module: external
    interface: http
    endpoint: gmail.users.messages.send
dependencies:
  allowed_tiers:
  - 0
  - 1
  outbound_calls:
  - module: aios.runtime
    interface: http
    endpoint: /chat
  - module: memory.service
    interface: http
    endpoint: /memory/ingest
packet_contract:
  emits:
  - email_adapter.in
  - email_adapter.out
  - email_adapter.error
  requires_metadata:
  - task_id
  - thread_uuid
  - source
  - tool_id
packet_expectations:
  on_success:
    emits:
    - email_adapter.out
  on_error:
    emits:
    - email_adapter.error
  durability:
    success: durable
    error: durable
idempotency:
  pattern: event_id
  source: platform_event_id
  durability: none
  check_method: substrate_search
  cache_ttl_seconds: 86400
  dedupe_behavior: return_cached_response
threading:
  strategy: deterministic_uuidv5
  thread_key_fields:
  - email_from
  - email_subject
  - email_thread_id
  namespace: 6ba7b810-9dad-11d1-80b4-00c04fd430c8
error_policy:
  default: best_effort
  retries:
    enabled: false
    max_attempts: 0
  categories:
    invalid_signature:
      status: 401
      action: reject
    stale_timestamp:
      status: 401
      action: reject
    aios_failure:
      status: 200
      action: log_and_continue
    side_effect_failure:
      status: 200
      action: log_and_continue
    storage_failure:
      status: 200
      action: log_and_continue
observability:
  logs:
    enabled: true
    level: info
  metrics:
    enabled: true
  traces:
    enabled: true
runtime_touchpoints:
  touches_db: true
  touches_tools: true
  touches_external_network: true
  affects_boot: false
tier_expectations:
  requires_runtime_wiring: true
  requires_packet_contract: true
  requires_negative_tests: false
test_scope:
  unit: true
  integration: true
  docker_smoke: true
acceptance:
  positive:
  - valid_email_processed
  - idempotent_replay_cached
  - email_parsed_correctly
  - aios_response_forwarded
  - packet_written_on_success
  - attachment_handling
  negative:
  - invalid_auth_rejected
  - duplicate_event_deduped
global_invariants_ack:
  emits_packet_on_ingress: true
  unknown_tool_id_hard_fail: true
spec_confidence:
  level: high
repo:
  root_path: L9
  allowed_new_files:
  - api/adapters/email_adapter_adapter.py
  - api/routes/email_adapter.py
  - api/clients/email_adapter_client.py
  - tests/test_email_adapter.py
  - docs/email_adapter.md
  allowed_modified_files:
  - api/server.py
interfaces:
  inbound:
  - name: email_adapter_endpoint
    method: POST
    route: /email/webhook
    auth: bearer
    payload_type: JSON
  outbound:
  - name: aios_runtime_call
    endpoint: /chat
    method: POST
    timeout_seconds: 30
    retry: false
  - name: memory_service_call
    endpoint: /memory/ingest
    method: POST
    timeout_seconds: 30
    retry: false
  - name: gmail_users_messages_get
    endpoint: https://api.gmail.com/...
    method: POST
    timeout_seconds: 10
    retry: true
  - name: gmail_users_messages_send
    endpoint: https://api.gmail.com/...
    method: POST
    timeout_seconds: 10
    retry: true
environment:
  required:
  - EMAIL_ADAPTER_SIGNING_SECRET
  - GMAIL_API_KEY
  optional:
  - EMAIL_ADAPTER_ENABLED
  - EMAIL_ADAPTER_LOG_LEVEL
orchestration:
  validation:
  - verify_signature
  - check_timestamp_freshness
  - parse_and_validate_payload
  context_reads:
  - search_conversation_history
  side_effects:
  - write_inbound_packet
  - write_outbound_packet
  - send_external_response
boot_impact:
  level: soft
standards:
  logging:
    library: structlog
  http_client:
    library: httpx
goals:
- Receives inbound emails via webhook, parses content, and routes to AIOS for processing.
  Supports Gmail API integration.
- Integrate with L9 memory substrate
- Emit standardized packets (email_adapter.*)
non_goals:
- No new database tables
- No new migrations
- No parallel memory/logging systems
notes_for_generators:
- 'Module tier: 1 (Integrations + Mac Extensions)'
- 'Placement: fastapi_route_handler'
- 'Idempotency: event_id (none)'
- Policy rules applied at 2025-12-18T06:24:54.831826+00:00
- 'Spec finalized with hash: SPEC-62d9295fc71f'
codegen_hints:
  completeness_target: 0.8
  allow_real_logic: true
  allow_real_tests: true
  stub_strategy: production_scaffold
  forbid_guessing: true
  refuse_if_missing:
  - runtime_wiring
  - dependency_contract
  - packet_contract
  - acceptance
delivery_metrics:
  track:
  - lead_time
  - change_frequency
  - change_failure_rate
  - recovery_time
  ownership:
    primary: integrations
    escalation: integrations_lead
  enforcement:
    human_editing_forbidden: true
    ci_owned: true
maturity:
  stage: beta
  production_ready: false
escalation_policy:
  on_repeated_failure:
    threshold: 3
    window: 24h
    escalate_to: integrations_lead
