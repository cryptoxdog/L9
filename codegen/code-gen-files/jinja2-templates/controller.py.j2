"""
{{ schema.system.system }} - Controller
{{ '=' * (schema.system.system|length + 13) }}

{{ schema.system.role }}

Auto-generated by L9 Research Factory from schema v{{ schema.metadata.version }}.

Version: 1.0.0
"""

from __future__ import annotations

import logging
from datetime import datetime
from typing import Any, Optional, Protocol
from uuid import UUID, uuid4

from pydantic import BaseModel, Field

logger = logging.getLogger(__name__)


# =============================================================================
# Protocols (Interfaces)
# =============================================================================
{% if schema.integration.connectto %}

{% for connection in schema.integration.connectto %}
# TODO: Import from {{ connection }}
{% endfor %}
{% endif %}


class MemorySubstrateProtocol(Protocol):
    """Protocol for memory substrate interaction."""
    
    async def write_packet(self, packet: Any) -> Any:
        """Write a packet to the substrate."""
        ...
    
    async def search_packets(self, thread_id: UUID, limit: int = 100) -> list[dict[str, Any]]:
        """Search packets by thread ID."""
        ...


{% if schema.governance.mode != 'autonomous' %}
class GovernanceProtocol(Protocol):
    """Protocol for governance interaction."""
    
    async def request_approval(self, action: str, context: dict[str, Any]) -> bool:
        """Request approval for an action."""
        ...
    
    async def escalate(self, reason: str, context: dict[str, Any]) -> None:
        """Escalate a decision to governance anchors."""
        ...
{% endif %}


# =============================================================================
# Request/Response Models
# =============================================================================

class {{ schema.system.name }}Request(BaseModel):
    """Input request model for {{ schema.system.name }}."""
    
    id: UUID = Field(default_factory=uuid4, description="Request ID")
    payload: dict[str, Any] = Field(default_factory=dict, description="Request payload")
    context: dict[str, Any] = Field(default_factory=dict, description="Additional context")
    source_id: str = Field(default="api", description="Request source")
    timestamp: datetime = Field(default_factory=datetime.utcnow)
    
    model_config = {"extra": "forbid"}


class {{ schema.system.name }}Response(BaseModel):
    """Output response model for {{ schema.system.name }}."""
    
    ok: bool = Field(..., description="Whether the operation succeeded")
    request_id: UUID = Field(..., description="Original request ID")
    result: Optional[dict[str, Any]] = Field(None, description="Operation result")
    error: Optional[str] = Field(None, description="Error message if failed")
    duration_ms: int = Field(default=0, description="Processing duration in milliseconds")
    
    model_config = {"extra": "forbid"}


# =============================================================================
# Controller Class
# =============================================================================

class {{ schema.system.name }}Controller:
    """
    Controller for {{ schema.system.name }}.
    
    {{ schema.system.role }}
    
    Governance Mode: {{ schema.governance.mode }}
    {% if schema.governance.anchors %}
    Governance Anchors: {{ schema.governance.anchors | join(', ') }}
    {% endif %}
    """
    
    def __init__(
        self,
        substrate_service: MemorySubstrateProtocol,
{% if schema.governance.mode != 'autonomous' %}
        governance_service: Optional[GovernanceProtocol] = None,
{% endif %}
    ):
        """
        Initialize the controller.
        
        Args:
            substrate_service: Memory substrate for packet persistence
{% if schema.governance.mode != 'autonomous' %}
            governance_service: Governance service for approvals/escalations
{% endif %}
        """
        self._substrate = substrate_service
{% if schema.governance.mode != 'autonomous' %}
        self._governance = governance_service
{% endif %}
        self._initialized = False
        
        logger.info("{{ schema.system.name }}Controller initialized")
    
    # =========================================================================
    # Lifecycle
    # =========================================================================
    
    async def startup(self) -> None:
        """Initialize resources on startup."""
        logger.info("{{ schema.system.name }} starting up...")
        
        # TODO: Initialize connections
{% for connection in schema.integration.connectto %}
        # - {{ connection }}
{% endfor %}
        
        self._initialized = True
        logger.info("{{ schema.system.name }} started")
    
    async def shutdown(self) -> None:
        """Clean up resources on shutdown."""
        logger.info("{{ schema.system.name }} shutting down...")
        
        # TODO: Clean up connections
        
        self._initialized = False
        logger.info("{{ schema.system.name }} shutdown complete")
    
    # =========================================================================
    # Main API
    # =========================================================================
    
    async def process(self, request: {{ schema.system.name }}Request) -> {{ schema.system.name }}Response:
        """
        Process an incoming request.
        
        Args:
            request: Input request
            
        Returns:
            {{ schema.system.name }}Response with result or error
        """
        start_time = datetime.utcnow()
        
        try:
            logger.info(
                "{{ schema.system.name }}.process: request_id=%s, source=%s",
                str(request.id),
                request.source_id,
            )
            
{% if schema.governance.mode != 'autonomous' %}
            # Check governance approval if required
            if self._governance:
                approved = await self._governance.request_approval(
                    action="process",
                    context={"request_id": str(request.id), "payload": request.payload},
                )
                if not approved:
                    return {{ schema.system.name }}Response(
                        ok=False,
                        request_id=request.id,
                        error="Governance approval denied",
                        duration_ms=self._calc_duration(start_time),
                    )
{% endif %}
            
            # TODO: Implement processing logic
            result = await self._execute(request)
            
            duration_ms = self._calc_duration(start_time)
            
            logger.info(
                "{{ schema.system.name }}.process.success: request_id=%s, duration_ms=%d",
                str(request.id),
                duration_ms,
            )
            
            return {{ schema.system.name }}Response(
                ok=True,
                request_id=request.id,
                result=result,
                duration_ms=duration_ms,
            )
            
        except Exception as e:
            logger.exception(
                "{{ schema.system.name }}.process.error: request_id=%s, error=%s",
                str(request.id),
                str(e),
            )
            
{% if schema.governance.mode != 'autonomous' and schema.governance.escalationpolicy %}
            # Escalate on error
            if self._governance:
                await self._governance.escalate(
                    reason=f"Processing error: {e}",
                    context={"request_id": str(request.id)},
                )
{% endif %}
            
            return {{ schema.system.name }}Response(
                ok=False,
                request_id=request.id,
                error=str(e),
                duration_ms=self._calc_duration(start_time),
            )
    
    # =========================================================================
    # Internal Methods
    # =========================================================================
    
    async def _execute(self, request: {{ schema.system.name }}Request) -> dict[str, Any]:
        """
        Execute the main processing logic.
        
        Args:
            request: Input request
            
        Returns:
            Processing result
        """
        # TODO: Implement agent-specific logic
        return {
            "status": "processed",
            "request_id": str(request.id),
            "message": "Processing complete",
        }
    
    def _calc_duration(self, start_time: datetime) -> int:
        """Calculate duration in milliseconds."""
        return int((datetime.utcnow() - start_time).total_seconds() * 1000)
    
    # =========================================================================
    # Health Check
    # =========================================================================
    
    async def health_check(self) -> dict[str, Any]:
        """
        Check controller health.
        
        Returns:
            Health status dict
        """
        return {
            "agent": "{{ schema.system.name }}",
            "status": "healthy" if self._initialized else "not_initialized",
            "governance_mode": "{{ schema.governance.mode }}",
{% if schema.metadata.version %}
            "version": "{{ schema.metadata.version }}",
{% endif %}
        }


# =============================================================================
# Factory Function
# =============================================================================

def create_{{ schema.system.name | lower }}_controller(
    substrate_service: MemorySubstrateProtocol,
{% if schema.governance.mode != 'autonomous' %}
    governance_service: Optional[GovernanceProtocol] = None,
{% endif %}
) -> {{ schema.system.name }}Controller:
    """
    Factory function to create a {{ schema.system.name }}Controller.
    
    Args:
        substrate_service: Memory substrate service
{% if schema.governance.mode != 'autonomous' %}
        governance_service: Optional governance service
{% endif %}
        
    Returns:
        Configured {{ schema.system.name }}Controller
    """
    return {{ schema.system.name }}Controller(
        substrate_service=substrate_service,
{% if schema.governance.mode != 'autonomous' %}
        governance_service=governance_service,
{% endif %}
    )


# =============================================================================
# Public API
# =============================================================================

__all__ = [
    "{{ schema.system.name }}Controller",
    "{{ schema.system.name }}Request",
    "{{ schema.system.name }}Response",
    "create_{{ schema.system.name | lower }}_controller",
]

