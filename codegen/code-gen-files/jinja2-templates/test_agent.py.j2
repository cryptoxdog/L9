"""
Tests for {{ schema.system.name }}
{{ '=' * (schema.system.name|length + 10) }}

Auto-generated by L9 Research Factory from schema v{{ schema.metadata.version }}.

Test coverage targets:
- Controller initialization
- Request/response models
- Processing flow
- Error handling
- Health check

Version: 1.0.0
"""

from __future__ import annotations

from datetime import datetime
from typing import Any
from unittest.mock import AsyncMock, MagicMock
from uuid import UUID, uuid4

import pytest

from {{ schema.system.rootpath | replace('/', '.') }}.controller import (
    {{ schema.system.name }}Controller,
    {{ schema.system.name }}Request,
    {{ schema.system.name }}Response,
    create_{{ schema.system.name | lower }}_controller,
)


# =============================================================================
# Fixtures
# =============================================================================

@pytest.fixture
def mock_substrate():
    """Create a mock substrate service."""
    substrate = MagicMock()
    substrate.write_packet = AsyncMock(return_value={"id": str(uuid4())})
    substrate.search_packets = AsyncMock(return_value=[])
    return substrate


{% if schema.governance.mode != 'autonomous' %}
@pytest.fixture
def mock_governance():
    """Create a mock governance service."""
    governance = MagicMock()
    governance.request_approval = AsyncMock(return_value=True)
    governance.escalate = AsyncMock()
    return governance
{% endif %}


@pytest.fixture
def controller(mock_substrate{% if schema.governance.mode != 'autonomous' %}, mock_governance{% endif %}):
    """Create a controller instance for testing."""
    return {{ schema.system.name }}Controller(
        substrate_service=mock_substrate,
{% if schema.governance.mode != 'autonomous' %}
        governance_service=mock_governance,
{% endif %}
    )


@pytest.fixture
def sample_request():
    """Create a sample request for testing."""
    return {{ schema.system.name }}Request(
        payload={"test": "data"},
        context={"source": "test"},
        source_id="test",
    )


# =============================================================================
# Model Tests
# =============================================================================

class TestRequestModel:
    """Tests for {{ schema.system.name }}Request model."""
    
    def test_create_with_defaults(self):
        """Test creating request with default values."""
        request = {{ schema.system.name }}Request()
        
        assert request.id is not None
        assert isinstance(request.id, UUID)
        assert request.payload == {}
        assert request.context == {}
        assert request.source_id == "api"
        assert request.timestamp is not None
    
    def test_create_with_values(self):
        """Test creating request with custom values."""
        request = {{ schema.system.name }}Request(
            payload={"key": "value"},
            context={"ctx": "data"},
            source_id="custom",
        )
        
        assert request.payload == {"key": "value"}
        assert request.context == {"ctx": "data"}
        assert request.source_id == "custom"


class TestResponseModel:
    """Tests for {{ schema.system.name }}Response model."""
    
    def test_success_response(self):
        """Test creating a success response."""
        request_id = uuid4()
        response = {{ schema.system.name }}Response(
            ok=True,
            request_id=request_id,
            result={"status": "done"},
            duration_ms=100,
        )
        
        assert response.ok is True
        assert response.request_id == request_id
        assert response.result == {"status": "done"}
        assert response.error is None
        assert response.duration_ms == 100
    
    def test_error_response(self):
        """Test creating an error response."""
        request_id = uuid4()
        response = {{ schema.system.name }}Response(
            ok=False,
            request_id=request_id,
            error="Something went wrong",
            duration_ms=50,
        )
        
        assert response.ok is False
        assert response.error == "Something went wrong"
        assert response.result is None


# =============================================================================
# Controller Tests
# =============================================================================

class TestControllerInit:
    """Tests for controller initialization."""
    
    def test_controller_creation(self, mock_substrate{% if schema.governance.mode != 'autonomous' %}, mock_governance{% endif %}):
        """Test controller can be created."""
        controller = {{ schema.system.name }}Controller(
            substrate_service=mock_substrate,
{% if schema.governance.mode != 'autonomous' %}
            governance_service=mock_governance,
{% endif %}
        )
        
        assert controller is not None
        assert controller._initialized is False
    
    def test_factory_function(self, mock_substrate{% if schema.governance.mode != 'autonomous' %}, mock_governance{% endif %}):
        """Test factory function creates controller."""
        controller = create_{{ schema.system.name | lower }}_controller(
            substrate_service=mock_substrate,
{% if schema.governance.mode != 'autonomous' %}
            governance_service=mock_governance,
{% endif %}
        )
        
        assert controller is not None
        assert isinstance(controller, {{ schema.system.name }}Controller)


class TestControllerLifecycle:
    """Tests for controller lifecycle."""
    
    @pytest.mark.asyncio
    async def test_startup(self, controller):
        """Test controller startup."""
        await controller.startup()
        
        assert controller._initialized is True
    
    @pytest.mark.asyncio
    async def test_shutdown(self, controller):
        """Test controller shutdown."""
        await controller.startup()
        await controller.shutdown()
        
        assert controller._initialized is False
    
    @pytest.mark.asyncio
    async def test_health_check_before_init(self, controller):
        """Test health check before initialization."""
        health = await controller.health_check()
        
        assert health["status"] == "not_initialized"
        assert health["agent"] == "{{ schema.system.name }}"
    
    @pytest.mark.asyncio
    async def test_health_check_after_init(self, controller):
        """Test health check after initialization."""
        await controller.startup()
        health = await controller.health_check()
        
        assert health["status"] == "healthy"


class TestControllerProcess:
    """Tests for controller processing."""
    
    @pytest.mark.asyncio
    async def test_process_success(self, controller, sample_request):
        """Test successful processing."""
        await controller.startup()
        
        response = await controller.process(sample_request)
        
        assert response.ok is True
        assert response.request_id == sample_request.id
        assert response.result is not None
        assert response.duration_ms >= 0
    
    @pytest.mark.asyncio
    async def test_process_returns_request_id(self, controller, sample_request):
        """Test that response contains original request ID."""
        await controller.startup()
        
        response = await controller.process(sample_request)
        
        assert response.request_id == sample_request.id


{% if schema.governance.mode != 'autonomous' %}
class TestGovernance:
    """Tests for governance integration."""
    
    @pytest.mark.asyncio
    async def test_governance_approval_granted(self, controller, mock_governance, sample_request):
        """Test processing when governance approves."""
        mock_governance.request_approval.return_value = True
        await controller.startup()
        
        response = await controller.process(sample_request)
        
        assert response.ok is True
        mock_governance.request_approval.assert_called_once()
    
    @pytest.mark.asyncio
    async def test_governance_approval_denied(self, controller, mock_governance, sample_request):
        """Test processing when governance denies."""
        mock_governance.request_approval.return_value = False
        await controller.startup()
        
        response = await controller.process(sample_request)
        
        assert response.ok is False
        assert "approval denied" in response.error.lower()
{% endif %}


# =============================================================================
# Error Handling Tests
# =============================================================================

class TestErrorHandling:
    """Tests for error handling."""
    
    @pytest.mark.asyncio
    async def test_process_handles_exception(self, controller, sample_request):
        """Test that exceptions are handled gracefully."""
        await controller.startup()
        
        # Force an error by mocking internal method
        controller._execute = AsyncMock(side_effect=ValueError("Test error"))
        
        response = await controller.process(sample_request)
        
        assert response.ok is False
        assert response.error is not None
        assert "Test error" in response.error

