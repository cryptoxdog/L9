# GMP-3 ‚Äî Dedicated GMP Worker + Queue Wiring (with Igor Approval Constraint)

You are C (Cursor) operating inside the L9 repository and the local GMP runner repo (Cursor automation).

You are not altering the planning behavior of agents.
You are implementing the execution infrastructure for GMP runs, under a strict ‚ÄúIgor approves‚Äù constraint.

## üéØ OBJECTIVE (LOCKED)

Create a dedicated **GMP executor path** that:

1. Uses a dedicated queue (e.g., `l9:gmp_runs`) via `TaskQueue`. [file:166]
2. Has a `GMPWorker` that talks to the local GMP runner (`runner.py`, `executor.py`, `websocket_client.py`). [file:171][file:174][file:176]
3. Enforces that any actual run of a GMP is triggered only **after Igor‚Äôs explicit approval**, but still allows L to propose/enqueue pending GMP requests.

## üß± SCOPE (FILES ONLY)

You MAY modify:

- `task_queue.py`
- A new or existing worker module (e.g., `gmp_worker.py` or `executor.py` in the L9 runtime) ‚Äî only `.py`.
- Local GMP runner Python files:
  - `runner.py`
  - `executor.py`
  - `websocket_client.py`

You MAY NOT:

- Change non-`.py` files.
- Remove safety checks, authentication, or whitelists.

## REQUIRED CHANGES

1Ô∏è‚É£ Dedicated GMP queue

- Create a `TaskQueue` instance for GMP runs:
  - Queue name: `l9:gmp_runs`.
- Add a task schema for GMP runs, e.g.:
  - `{"type": "gmp_run", "gmp_markdown": str, "repo_root": str, "caller": str, "metadata": {...}}`.

2Ô∏è‚É£ GMP Worker

- Implement a worker coroutine/class (e.g., `GMPWorker`) that:
  - Dequeues tasks from `l9:gmp_runs`. [file:166]
  - Integrates with `runner.py` / `executor.py` / `websocket_client.py` to:
    - Open the target repo in Cursor.
    - Apply the GMP.
    - Stream/log results.

3Ô∏è‚É£ Igor Approval Gate

- Do **not** let L directly trigger execution.
- Instead:
  - Define a ‚Äúpending GMP request‚Äù pattern:
    - L‚Äôs tool `gmp_run` enqueues a task with a status `pending_igor_approval`.
    - The worker **only executes** tasks that are marked `approved_by_igor=True` in payload.
- Provide a clear interface (Python function or CLI entrypoint) that Igor can use to:
  - Inspect pending GMP tasks.
  - Approve or reject them (setting the flag).

4Ô∏è‚É£ Tool Hook

- Implement the `gmp_run` tool implementation (for L) to:
  - Only create **pending** tasks in `l9:gmp_runs`.
  - Return the task id and a summary blob L can reference in conversation.

## FINAL VALIDATION

- It is possible to:
  - Create pending GMP tasks via the `gmp_run` tool.
  - Approve them via an Igor-only interface.
  - Observe execution by the worker against the repo via Cursor.
- No GMP executes without `approved_by_igor=True` in payload.

END PROMPT ‚Äî EXECUTE FULLY, THEN STOP.
