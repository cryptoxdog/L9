# ============================================================================
# L9 UNIVERSAL MODULE SPEC — v2.5.0 (NORMALIZED / SSOT-INGESTED)
# ============================================================================
# Purpose: Define WHAT to build — a single spec is sufficient to:
#   - Determine runtime placement
#   - Determine startup order
#   - Determine service dependencies
#   - Determine failure blast radius
#   - Determine observability requirements
#   - Determine test obligations
#   - Generate docker-compose wiring
#   - Generate runtime + smoke tests
#
# v2.5 is a NORMALIZATION RELEASE:
#   - NO behavioral change from v2.4
#   - Absorbs existing SSOT semantics into explicit schema fields
#   - Removes remaining interpretation
#   - Makes all concepts machine-readable
#
# Audience: User fills → P consumes → C wires → Runtime executes → CI validates
# Part of Trio: [Spec] → [P-Prompt] → [C-Prompt]
#
# Changelog v2.5.0:
#   - Added DEPENDENCY_CONTRACT (directional normalization)
#   - Added RUNTIME_CONTRACT (semantic labeling)
#   - Added PACKET_EXPECTATIONS (explicit outcome mapping)
#   - Added TIER_EXPECTATIONS (machine-readable tier rules)
#   - NO behavioral change from v2.4
#
# Prior versions: v2.1 (base), v2.2 (invariants), v2.3 (surface), v2.4 (runtime)
# ============================================================================

# Schema version for validation gating
schema_version: "2.5"

# ============================================================================
# SECTION 1: METADATA (REQUIRED)
# ============================================================================
metadata:
  module_id: "{{module_id}}"
  name: "{{Module Name}}"
  tier: "{{0 | 1 | 2 | 3 | 4 | 5 | 6 | 7}}"
  description: "{{Brief description of what this module does}}"
  system: "L9"
  language: "python"
  runtime: "python>=3.11"

# ============================================================================
# SECTION 2: OWNERSHIP (REQUIRED)
# ============================================================================
ownership:
  team: "{{core | infra | integrations | security | observability}}"
  primary_contact: "{{role_name}}"

# ============================================================================
# SECTION 3: RUNTIME WIRING (REQUIRED — KEYSTONE)
# ============================================================================
runtime_wiring:
  service: "{{api | worker | scheduler | memory}}"
  startup_phase: "{{early | normal | late}}"
  depends_on:
    - "{{postgres | redis | memory.service | ...}}"
  blocks_startup_on_failure: "{{true | false}}"

# ============================================================================
# SECTION 4: RUNTIME CONTRACT (REQUIRED — v2.5 NEW)
# ============================================================================
# v2.5: Semantic labeling ONLY. Does NOT alter startup, wiring, or blocking.
# Labels for tooling and reasoning. Must align with runtime_wiring.
# ============================================================================
runtime_contract:
  # REQUIRED — What type of runtime component is this?
  runtime_class: "{{control_plane | data_plane | background}}"
  
  # REQUIRED — How is this module triggered?
  execution_model: "{{request_driven | event_driven | scheduled}}"

# ============================================================================
# SECTION 5: EXTERNAL SURFACE (REQUIRED)
# ============================================================================
external_surface:
  exposes_http_endpoint: "{{true | false}}"
  exposes_webhook: "{{true | false}}"
  exposes_tool: "{{true | false}}"
  callable_from:
    - "{{external | internal}}"

# ============================================================================
# SECTION 6: DEPENDENCY CONTRACT (REQUIRED — v2.5 NEW)
# ============================================================================
# v2.5: Directional normalization. Mirrors existing dependency logic.
# Direction MUST be explicit. No new validation rules beyond clarity.
# ============================================================================
dependency_contract:
  # REQUIRED — Who calls INTO this module?
  inbound:
    - from_module: "{{caller_module}}"
      interface: "{{http | tool}}"
      endpoint: "{{inbound_route}}"
  
  # REQUIRED — Who does this module call OUT to?
  outbound:
    - to_module: "{{target_module}}"
      interface: "{{http | tool}}"
      endpoint: "{{target_endpoint}}"

# ============================================================================
# SECTION 7: DEPENDENCIES (REQUIRED)
# ============================================================================
dependencies:
  allowed_tiers:
    - 0
    - 1
    - 2
  
  outbound_calls:
    - module: "memory.service"
      interface: "{{http | tool}}"
      endpoint: "/memory/ingest"
    
    - module: "aios.runtime"
      interface: "http"
      endpoint: "/chat"

# ============================================================================
# SECTION 8: PACKET CONTRACT (REQUIRED)
# ============================================================================
packet_contract:
  emits:
    - "{{module}}.in"
    - "{{module}}.out"
    - "{{module}}.error"
  
  requires_metadata:
    - "task_id"
    - "thread_uuid"
    - "source"
    - "tool_id"

# ============================================================================
# SECTION 9: PACKET EXPECTATIONS (REQUIRED — v2.5 NEW)
# ============================================================================
# v2.5: Explicit outcome mapping. Clarifies packet behavior already in doctrine.
# No new packet types allowed. Must match existing packet_contract.
# ============================================================================
packet_expectations:
  # REQUIRED — What packets are emitted on success?
  on_success:
    emits:
      - "{{module}}.out"
  
  # REQUIRED — What packets are emitted on error?
  on_error:
    emits:
      - "{{module}}.error"
  
  # REQUIRED — Durability guarantees
  durability:
    success: "{{durable | best_effort}}"
    error: "{{durable | best_effort}}"

# ============================================================================
# SECTION 10: IDEMPOTENCY (REQUIRED)
# ============================================================================
idempotency:
  pattern: "{{event_id | composite_key | substrate_lookup}}"
  source: "{{platform_event_id | webhook_header | computed_hash}}"
  durability: "{{in_memory | substrate}}"

# ============================================================================
# SECTION 11: ERROR POLICY (REQUIRED)
# ============================================================================
error_policy:
  default: "{{fail_fast | best_effort}}"
  
  retries:
    enabled: "{{true | false}}"
    max_attempts: "{{0 | 1 | 3}}"
  
  escalation:
    emit_error_packet: "{{true | false}}"
    mark_task_failed: "{{true | false}}"
    alert: "{{none | log | metric}}"
  
  invalid_signature:
    status: 401
    action: "Reject immediately"
    log: "signature_invalid"
  
  stale_timestamp:
    status: 401
    action: "Reject immediately"
    log: "timestamp_stale"
  
  aios_failure:
    status: 200
    action: "Log error, return ok"
    log: "aios_call_failed"
  
  side_effect_failure:
    status: 200
    action: "Log error, return ok"
    log: "reply_failed"
  
  storage_failure:
    status: 200
    action: "Log error, continue"
    log: "packet_storage_failed"

# ============================================================================
# SECTION 12: OBSERVABILITY (REQUIRED)
# ============================================================================
observability:
  logs:
    enabled: true
    level: "{{info | debug}}"
  
  metrics:
    enabled: true
    counters:
      - "{{module}}_requests_total"
      - "{{module}}_errors_total"
    histograms:
      - "{{module}}_latency_seconds"
  
  traces:
    enabled: "{{true | false}}"

# ============================================================================
# SECTION 13: RUNTIME TOUCHPOINTS (REQUIRED)
# ============================================================================
runtime_touchpoints:
  touches_db: "{{true | false}}"
  touches_tools: "{{true | false}}"
  touches_external_network: "{{true | false}}"
  affects_boot: "{{true | false}}"

# ============================================================================
# SECTION 14: TIER EXPECTATIONS (REQUIRED — v2.5 NEW)
# ============================================================================
# v2.5: Machine-readable tier rules. No tier logic changes.
# Purpose is elimination of inference.
# ============================================================================
tier_expectations:
  # REQUIRED — Does this tier require runtime_wiring section?
  requires_runtime_wiring: "{{true | false}}"
  
  # REQUIRED — Does this tier require packet_contract section?
  requires_packet_contract: "{{true | false}}"
  
  # REQUIRED — Does this tier require negative acceptance tests?
  requires_negative_tests: "{{true | false}}"

# ============================================================================
# SECTION 15: TEST SCOPE (REQUIRED)
# ============================================================================
test_scope:
  unit: true
  integration: "{{true | false}}"
  docker_smoke: "{{true | false}}"

# ============================================================================
# SECTION 16: ACCEPTANCE (REQUIRED)
# ============================================================================
acceptance:
  
  positive:
    - id: "AP-1"
      description: "Valid request processed successfully"
      test: "test_valid_request_processes"
    
    - id: "AP-2"
      description: "Signature verification blocks invalid requests"
      test: "test_invalid_signature_returns_401"
    
    - id: "AP-3"
      description: "Packets are stored with correct metadata"
      test: "test_packet_stored_correctly"
    
    - id: "AP-4"
      description: "Thread UUID is deterministic"
      test: "test_thread_uuid_deterministic"
    
    - id: "AP-5"
      description: "Duplicate events are idempotent"
      test: "test_duplicate_event_skipped"
    
    - id: "AP-6"
      description: "AIOS response is forwarded"
      test: "test_aios_response_forwarded"
  
  negative:
    - id: "AN-1"
      description: "Unknown tool_id causes hard failure"
      expected_behavior: "Request rejected before execution"
      test: "test_unknown_tool_id_rejected"
    
    - id: "AN-2"
      description: "Malformed packet blocked at ingress"
      expected_behavior: "400 Bad Request with structured error"
      test: "test_malformed_packet_rejected"

# ============================================================================
# SECTION 17: GLOBAL INVARIANTS ACKNOWLEDGEMENT (REQUIRED)
# ============================================================================
global_invariants_ack:
  emits_packet_on_ingress: true
  tool_calls_traceable: true
  unknown_tool_id_hard_fail: true
  malformed_packet_blocked: true
  missing_env_fails_boot: true

# ============================================================================
# SECTION 18: SPEC CONFIDENCE (REQUIRED)
# ============================================================================
spec_confidence:
  level: "{{high | medium | low}}"
  basis:
    - "{{Existing code present | Spec-only, no implementation yet}}"
    - "{{Tested in production | Untested design}}"

# ============================================================================
# SECTION 19: FILE MANIFEST (REQUIRED)
# ============================================================================
repo:
  root_path: "/Users/ib-mac/Projects/L9"
  
  allowed_new_files:
    - "api/{{module}}_adapter.py"
    - "api/{{module}}_client.py"
    - "api/routes/{{module}}.py"
    - "memory/{{module}}_ingest.py"
    - "tests/test_{{module}}_adapter.py"
    - "tests/test_{{module}}_ingest.py"
    - "tests/test_{{module}}_smoke.py"
    - "docs/{{module}}.md"
  
  allowed_modified_files:
    - "api/server.py"

# ============================================================================
# SECTION 20: INTERFACES (REQUIRED)
# ============================================================================
interfaces:
  
  inbound:
    - name: "{{route_name}}"
      method: "POST"
      route: "/{{module}}/{{action}}"
      headers:
        - "X-{{Module}}-Signature"
        - "X-{{Module}}-Timestamp"
      payload_type: "JSON"
      auth: "{{hmac-sha256 | bearer | api_key | none}}"
  
  outbound:
    - name: "aios_chat"
      endpoint: "/chat"
      method: "POST"
      timeout_seconds: 30
      retry: false
    
    - name: "{{external_service}}"
      endpoint: "{{external_api_url}}"
      method: "POST"
      timeout_seconds: 10
      retry: true

# ============================================================================
# SECTION 21: ENVIRONMENT VARIABLES (REQUIRED)
# ============================================================================
environment:
  required:
    - name: "{{MODULE}}_SIGNING_SECRET"
      description: "Secret for HMAC signature verification"
    
    - name: "{{MODULE}}_API_TOKEN"
      description: "Token for external API calls"
  
  optional:
    - name: "AIOS_BASE_URL"
      description: "AIOS endpoint"
      default: "http://localhost:8000"

# ============================================================================
# SECTION 22: ORCHESTRATION FLOW (REQUIRED)
# ============================================================================
orchestration:
  
  validation:
    - "Verify signature (HMAC-SHA256)"
    - "Check timestamp freshness (< 5 minutes)"
    - "Parse and normalize payload"
  
  context_reads:
    - method: "substrate_service.search_packets"
      filter: "thread_uuid match"
      purpose: "Get conversation history"
  
  aios_calls:
    - endpoint: "/chat"
      input: "message + context"
      output: "response_text"
  
  side_effects:
    - action: "Reply to external service"
      service: "{{module}}_client.post_message"
    
    - action: "Store inbound packet"
      service: "substrate_service.write_packet"
      packet_type: "{{module}}.in"
    
    - action: "Store outbound packet"
      service: "substrate_service.write_packet"
      packet_type: "{{module}}.out"

# ============================================================================
# SECTION 23: BOOT IMPACT (REQUIRED)
# ============================================================================
boot_impact:
  level: "{{none | soft | hard}}"
  reason: "{{Explanation of boot impact}}"

# ============================================================================
# SECTION 24: MANDATORY STANDARDS (REQUIRED)
# ============================================================================
standards:
  
  identity:
    canonical_identifier: "tool_id"
  
  logging:
    library: "structlog"
    forbidden: ["logging", "print"]
  
  http_client:
    library: "httpx"
    forbidden: ["aiohttp", "requests"]

# ============================================================================
# SECTION 25: GOALS & NON-GOALS (REQUIRED)
# ============================================================================
goals:
  - "{{Primary goal}}"
  - "{{Secondary goal}}"

non_goals:
  - "{{What this module does NOT do}}"
  - "No new database tables"
  - "No new migrations"
  - "No parallel memory/logging/config systems"

# ============================================================================
# SECTION 26: NOTES FOR P
# ============================================================================
notes_for_perplexity:
  - "Use REPO_CONTEXT_PACK imports exactly"
  - "Use PacketEnvelopeIn for all packets"
  - "Use UUIDv5 for thread_id (not uuid4)"
  - "All handlers accept injected services (no singletons)"
  - "Validate emitted packets against packet_contract.emits"
  - "Include all packet_contract.requires_metadata on every packet"
  - "Generate docker smoke test if external_surface.exposes_http_endpoint"
  - "Generate boot-failure test if boot_impact.level == hard"
  - "Generate startup dependency test if runtime_wiring.blocks_startup_on_failure"
  - "Extract runtime_wiring for docker-compose generation"
  - "Extract observability for instrumentation"
  - "Extract ownership for incident routing"
  - "Validate depends_on against runtime manifest"
  # v2.5 additions:
  - "Use dependency_contract for directional call validation"
  - "Use runtime_contract for semantic classification"
  - "Use packet_expectations to validate outcome packets"
  - "Use tier_expectations to enforce tier-specific requirements"

# ============================================================================
# FORBIDDEN (SCHEMA-LEVEL)
# ============================================================================
# The schema MUST NOT allow:
# - "if applicable"
# - optional runtime wiring
# - inferred dependencies
# - undeclared packet emission
# - implicit boot behavior
# - silent failure
# - undeclared tier expectations
#
# Validation must fail loudly.
# ============================================================================

# ============================================================================
# VERSION COMPATIBILITY
# ============================================================================
# v2.1–v2.4 specs MUST remain loadable
# v2.5 fields are REQUIRED only when schema_version >= 2.5
# Validators must enforce strict version gating
# ============================================================================

# ============================================================================
# BEHAVIORAL CHANGE CONFIRMATION
# ============================================================================
# NO BEHAVIORAL CHANGE FROM v2.4
# v2.5 adds clarity, not power
# Runtime behavior remains identical
# All SSOT concepts are now machine-readable
# Diff is reviewable and boring (this is good)
# ============================================================================

# ============================================================================
# END OF MODULE SPEC v2.5.0 (NORMALIZED / SSOT-INGESTED)
# ============================================================================
